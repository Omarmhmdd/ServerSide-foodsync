<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantry API - Complete Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .config-section h2 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3494E6 0%, #EC6EAD 100%);
        }
        
        .test-section {
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
        }
        
        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .test-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .test-item h4 {
            color: #555;
            margin-bottom: 10px;
        }
        
        .test-item .endpoint {
            font-family: 'Courier New', monospace;
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 8px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 13px;
        }
        
        .response {
            margin-top: 10px;
            padding: 10px;
            background: #2d2d2d;
            color: #f8f8f2;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .response.success {
            border-left: 4px solid #38ef7d;
        }
        
        .response.error {
            border-left: 4px solid #f45c43;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status.pending {
            background: #ffc107;
            color: #000;
        }
        
        .status.success {
            background: #28a745;
            color: white;
        }
        
        .status.error {
            background: #dc3545;
            color: white;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
        }
        
        .log-entry.success {
            color: #4ec9b0;
        }
        
        .log-entry.error {
            color: #f48771;
        }
        
        .log-entry.info {
            color: #569cd6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Pantry API - Complete Test Suite</h1>
        <p class="subtitle">Test everything from 0 to hero, including AI features!</p>
        
        <div class="config-section">
            <h2>‚öôÔ∏è Configuration</h2>
            <div class="input-group">
                <label>Base URL:</label>
                <input type="text" id="baseUrl" value="http://localhost:8000/api/v0.1" placeholder="http://localhost:8000/api/v0.1">
            </div>
            <div class="input-group">
                <label>Email:</label>
                <input type="text" id="email" value="test@example.com" placeholder="your@email.com">
            </div>
            <div class="input-group">
                <label>Password:</label>
                <input type="password" id="password" value="password123" placeholder="your password">
            </div>
            <div class="input-group">
                <label>OpenAI API Key (for AI features):</label>
                <input type="text" id="openaiKey" value="" placeholder="sk-... (optional)">
            </div>
            <button class="btn-success" onclick="startFullTest()">üéØ Start Full Test (0 to Hero)</button>
            <button class="btn-info" onclick="testAIFeatures()">ü§ñ Test AI Features Only</button>
            <button class="btn-danger" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 0%">0%</div>
        </div>
        
        <div class="test-section">
            <h3>üìä Test Progress</h3>
            <div id="testResults"></div>
        </div>
        
        <div class="test-section">
            <h3>üìù Test Log</h3>
            <div class="log" id="testLog"></div>
        </div>
    </div>

    <script>
        const BASE_URL = () => document.getElementById('baseUrl').value;
        let token = '';
        let testResults = [];
        let currentStep = 0;
        const totalSteps = 37; // Updated: 36 + 1 (Update Expiry Date)

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateProgress(step, total) {
            const percent = Math.round((step / total) * 100);
            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('progress').textContent = `${percent}% (${step}/${total})`;
        }

        function addResult(testName, status, response) {
            testResults.push({ name: testName, status, response });
            const resultsDiv = document.getElementById('testResults');
            const item = document.createElement('div');
            item.className = 'test-item';
            item.innerHTML = `
                <h4>${testName} <span class="status ${status}">${status.toUpperCase()}</span></h4>
                <div class="response ${status}">${JSON.stringify(response, null, 2)}</div>
            `;
            resultsDiv.appendChild(item);
        }

        async function apiCall(method, endpoint, body = null, useToken = true) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (useToken && token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const options = {
                method,
                headers
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(`${BASE_URL()}${endpoint}`, options);
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    data = { error: 'Invalid JSON response', text: await response.text() };
                }
                return { status: response.status, data };
            } catch (error) {
                return { status: 0, data: { error: error.message, endpoint: `${BASE_URL()}${endpoint}` } };
            }
        }

        async function step(name, method, endpoint, body = null, useToken = true) {
            currentStep++;
            updateProgress(currentStep, totalSteps);
            log(`Testing: ${name}...`, 'info');
            
            const result = await apiCall(method, endpoint, body, useToken);
            const success = result.status >= 200 && result.status < 300;
            
            if (success) {
                log(`‚úÖ ${name} - SUCCESS`, 'success');
            } else {
                log(`‚ùå ${name} - FAILED (${result.status})`, 'error');
            }
            
            addResult(name, success ? 'success' : 'error', result.data);
            return result;
        }

        async function startFullTest() {
            testResults = [];
            currentStep = 0;
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('testLog').innerHTML = '';
            log('üöÄ Starting Full Test Suite...', 'info');
            
            try {
                // STEP 1: Register
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                log('üìù Step 1: Registering user...', 'info');
                let result = await step('1. Register User', 'POST', '/auth/register', {
                    name: 'Test User',
                    email: email,
                    password: password
                }, false);
                
                if (result.status === 422) {
                    log('‚ö†Ô∏è User already exists, trying login...', 'info');
                }
                
                // STEP 2: Login
                log('üîê Step 2: Logging in...', 'info');
                result = await step('2. Login', 'POST', '/auth/login', {
                    email: email,
                    password: password
                }, false);
                
                if (result.data.payload && result.data.payload.token) {
                    token = result.data.payload.token;
                    log(`‚úÖ Token received: ${token.substring(0, 20)}...`, 'success');
                } else {
                    log('‚ùå Failed to get token!', 'error');
                    return;
                }
                
                // STEP 3: Get Current User
                await step('3. Get Current User', 'GET', '/auth/me');
                
                // STEP 4: Create Household
                log('üè† Step 4: Creating household...', 'info');
                result = await step('4. Create Household', 'POST', '/household', {
                    name: 'Test Family'
                });
                const householdId = result.data.payload?.id;
                
                // STEP 5: Get Household
                await step('5. Get Household', 'GET', '/household');
                
                // STEP 6-11: Create Units
                log('üìè Step 6-11: Creating units...', 'info');
                await step('6. Create Unit - Kilogram', 'POST', '/units', { name: 'Kilogram', abbreviation: 'kg' });
                await step('7. Create Unit - Gram', 'POST', '/units', { name: 'Gram', abbreviation: 'g' });
                await step('8. Create Unit - Liter', 'POST', '/units', { name: 'Liter', abbreviation: 'L' });
                await step('9. Create Unit - Milliliter', 'POST', '/units', { name: 'Milliliter', abbreviation: 'mL' });
                await step('10. Create Unit - Cup', 'POST', '/units', { name: 'Cup', abbreviation: 'cup' });
                await step('11. Create Unit - Piece', 'POST', '/units', { name: 'Piece', abbreviation: 'pc' });
                
                // STEP 12: Get All Units
                const unitsResult = await step('12. Get All Units', 'GET', '/units');
                const units = unitsResult.data.payload || [];
                const unitId = units.length > 0 ? units[0].id : 1;
                
                // STEP 13-15: Create Ingredients
                log('ü•© Step 13-15: Creating ingredients...', 'info');
                await step('13. Create Ingredient - Chicken', 'POST', '/ingredients', {
                    name: 'Chicken Breast',
                    calories: 165,
                    protein: 31,
                    carbs: 0,
                    fat: 3.6
                });
                await step('14. Create Ingredient - Milk', 'POST', '/ingredients', {
                    name: 'Milk',
                    calories: 42,
                    protein: 3.4,
                    carbs: 5,
                    fat: 1
                });
                await step('15. Create Ingredient - Tomatoes', 'POST', '/ingredients', {
                    name: 'Tomatoes',
                    calories: 18,
                    protein: 0.9,
                    carbs: 3.9,
                    fat: 0.2
                });
                
                // STEP 16: Get All Ingredients
                const ingredientsResult = await step('16. Get All Ingredients', 'GET', '/ingredients');
                const ingredients = ingredientsResult.data.payload || [];
                const ingredientId = ingredients.length > 0 ? ingredients[0].id : 1;
                
                // STEP 17-19: Create Pantry Items
                log('üì¶ Step 17-19: Creating pantry items...', 'info');
                await step('17. Create Pantry Item - Chicken', 'POST', '/pantry', {
                    ingredient_id: ingredientId,
                    quantity: 2,
                    unit_id: unitId,
                    expiry_date: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    location: 'Freezer'
                });
                await step('18. Create Pantry Item - Milk', 'POST', '/pantry', {
                    ingredient_id: ingredients.length > 1 ? ingredients[1].id : ingredientId,
                    quantity: 1,
                    unit_id: unitId,
                    expiry_date: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    location: 'Fridge'
                });
                
                // STEP 20: Get All Pantry Items
                await step('20. Get All Pantry Items', 'GET', '/pantry');
                
                // STEP 21: Get Expiring Items (Expiry Dashboard)
                log('‚è∞ Step 21: Testing expiry dashboard...', 'info');
                const expiringResult = await step('21. Get Expiring Items (Expiry Dashboard)', 'GET', '/pantry/expiring?days=7');
                
                // STEP 21b: Update Expiry Date (if we have pantry items)
                const pantryResult = await apiCall('GET', '/pantry', null, true);
                if (pantryResult.data.payload && pantryResult.data.payload.length > 0) {
                    const pantryItemId = pantryResult.data.payload[0].id;
                    const newExpiryDate = new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    await step('21b. Update Expiry Date', 'POST', `/pantry/${pantryItemId}/expiry`, {
                        expiry_date: newExpiryDate
                    });
                }
                
                // STEP 22: Create Recipe
                log('üç≥ Step 22: Creating recipe...', 'info');
                const recipeResult = await step('22. Create Recipe', 'POST', '/recipes', {
                    title: 'Chicken Curry',
                    instructions: '1. Heat oil\n2. Add chicken\n3. Add spices\n4. Cook for 20 minutes',
                    tags: ['dinner', 'spicy'],
                    servings: 4,
                    prep_time: 15,
                    cook_time: 30,
                    ingredients: [
                        {
                            ingredient_id: ingredientId,
                            quantity: 500,
                            unit_id: unitId
                        }
                    ]
                });
                const recipeId = recipeResult.data.payload?.id;
                
                // STEP 23: Get All Recipes
                await step('23. Get All Recipes', 'GET', '/recipes');
                
                // STEP 24: Get Recipe Nutrition
                if (recipeId) {
                    log('ü•ó Step 24: Testing nutrition...', 'info');
                    await step('24. Get Recipe Nutrition', 'GET', `/nutrition/recipes/${recipeId}`);
                }
                
                // STEP 25: Get Recipe Suggestions (AI)
                log('ü§ñ Step 25: Testing AI recipe suggestions...', 'info');
                // Test without AI first (basic matching)
                await step('25a. Get Recipe Suggestions (Basic)', 'GET', '/recipes/suggestions?use_ai=false&limit=5');
                // Then test with AI
                await step('25b. Get Recipe Suggestions (AI)', 'GET', '/recipes/suggestions?use_ai=true&limit=5');
                
                // STEP 26: Get Ingredient Substitutions (AI)
                if (recipeId) {
                    log('üîÑ Step 26: Testing AI substitutions...', 'info');
                    await step('26. Get Ingredient Substitutions (AI)', 'GET', `/recipes/${recipeId}/substitutions`);
                }
                
                // STEP 27: Create Weekly Meal Plan
                log('üìÖ Step 27: Creating meal plan...', 'info');
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() + (7 - weekStart.getDay()));
                const weekResult = await step('27. Create Weekly Meal Plan', 'POST', '/meal-plans', {
                    start_date: weekStart.toISOString().split('T')[0]
                });
                const weekId = weekResult.data.payload?.id;
                
                // STEP 28: Add Meal to Week
                if (weekId && recipeId) {
                    await step('28. Add Meal to Week', 'POST', `/meal-plans/${weekId}/meals`, {
                        recipe_id: recipeId,
                        day: 0,
                        slot: 'dinner'
                    });
                }
                
                // STEP 29: Get Weekly Meal Plan
                if (weekId) {
                    await step('29. Get Weekly Meal Plan', 'GET', `/meal-plans?weekStartDate=${weekStart.toISOString().split('T')[0]}`);
                }
                
                // STEP 30: Get Weekly Nutrition
                if (weekId) {
                    await step('30. Get Weekly Nutrition', 'GET', `/nutrition/weeks/${weekId}`);
                }
                
                // STEP 31: Generate Shopping List
                if (weekId) {
                    log('üõí Step 31: Generating shopping list...', 'info');
                    await step('31. Generate Shopping List', 'POST', '/shopping-lists/generate', {
                        week_id: weekId,
                        title: 'Auto-generated Shopping List'
                    });
                }
                
                // STEP 32: Get All Shopping Lists
                await step('32. Get All Shopping Lists', 'GET', '/shopping-lists');
                
                // STEP 33: Create Expense
                log('üí∞ Step 33: Creating expense...', 'info');
                await step('33. Create Expense', 'POST', '/expenses', {
                    amount: 45.50,
                    date: new Date().toISOString().split('T')[0],
                    category: 'Groceries',
                    store: 'Walmart',
                    note: 'Weekly shopping'
                });
                
                // STEP 34: Get Expense Summary
                await step('34. Get Expense Summary', 'GET', '/expenses/summary?period=week');
                
                // STEP 35: Get All Expenses (to verify expense was created)
                await step('35. Get All Expenses', 'GET', '/expenses');
                
                // STEP 36: Get Weekly Insights (with AI Summary)
                log('üìä Step 36: Testing weekly insights with AI...', 'info');
                await step('36. Get Weekly Insights (AI Summary)', 'GET', `/insights/weekly?weekStartDate=${weekStart.toISOString().split('T')[0]}`);
                
                log('üéâ All tests completed!', 'success');
                updateProgress(totalSteps, totalSteps);
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }

        async function testAIFeatures() {
            testResults = [];
            currentStep = 0;
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('testLog').innerHTML = '';
            log('ü§ñ Starting AI Features Test...', 'info');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Login first
            log('üîê Logging in...', 'info');
            let result = await apiCall('POST', '/auth/login', {
                email: email,
                password: password
            }, false);
            
            if (result.data.payload && result.data.payload.token) {
                token = result.data.payload.token;
                log('‚úÖ Logged in successfully', 'success');
            } else {
                log('‚ùå Login failed!', 'error');
                return;
            }
            
            // Test AI Features
            log('ü§ñ Testing AI Recipe Suggestions...', 'info');
            await step('AI Recipe Suggestions', 'GET', '/recipes/suggestions?use_ai=true&limit=5');
            
            // Get a recipe ID first
            const recipesResult = await apiCall('GET', '/recipes', null, true);
            const recipes = recipesResult.data.payload || [];
            if (recipes.length > 0) {
                const recipeId = recipes[0].id;
                log('üîÑ Testing AI Substitutions...', 'info');
                await step('AI Ingredient Substitutions', 'GET', `/recipes/${recipeId}/substitutions`);
            }
            
            // Test Weekly Insights with AI
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() + (7 - weekStart.getDay()));
            log('üìä Testing Weekly Insights with AI Summary...', 'info');
            await step('Weekly Insights (AI Summary)', 'GET', `/insights/weekly?weekStartDate=${weekStart.toISOString().split('T')[0]}`);
            
            log('‚úÖ AI Features test completed!', 'success');
        }

        function clearLogs() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('testLog').innerHTML = '';
            testResults = [];
            currentStep = 0;
            updateProgress(0, totalSteps);
        }
    </script>
</body>
</html>
